name: Build and Deploy  # å®šä¹‰è¿™ä»½å·¥ä½œæµçš„åç§°

on: 
  push:
    branches:
      - main  # å½“å‘mainåˆ†æ”¯æ¨é€æ›´æ”¹æ—¶ï¼Œè§¦å‘æ­¤workflow

permissions:
  contents: write  # è®¾ç½®å¯¹ä»£ç å†…å®¹çš„å†™æƒé™

jobs:
  build-and-deploy:  # å®šä¹‰ä¸€ä¸ªjobï¼Œåä¸ºbuild-and-deploy
    concurrency: ci-${{ github.ref }}  # è®¾ç½®å¹¶å‘ï¼Œé˜²æ­¢åŒä¸€æ—¶é—´è¿è¡Œå¤šä¸ªç›¸åŒçš„workflow
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°ç‰ˆçš„ubuntu

    steps:  # ä¸‹é¢æ˜¯è¿™ä¸ªjobçš„ä¸»è¦æ­¥éª¤
      - name: Checkout ğŸ›ï¸  # ç¬¬ä¸€æ­¥ï¼šè·å–ä»£ç 
        uses: actions/checkout@v3  # ä½¿ç”¨actionåº“ä¸­çš„checkoutæ–¹æ³•

      - name: Check for package-lock.json  # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ package-lock.json æ–‡ä»¶
        id: check-lock-file  # è®¾ç½®è¿™ä¸ªæ­¥éª¤çš„idä¸ºcheck-lock-file
        run: |
          if [ -f package-lock.json ]; then
            echo "::set-output name=exists::true"
          else
            echo "::set-output name=exists::false"
          fi

      - name: Login to DockerHub  # ç¬¬ä¸‰æ­¥ï¼šç™»å½•DockerHub
        uses: docker/login-action@v2  # ä½¿ç”¨actionåº“ä¸­çš„docker/login-actionæ–¹æ³•
        with:  # è¾“å…¥DockerHubçš„ç”¨æˆ·åå’Œå¯†ç 
          username: ${{ secrets.DOCKER_USERNAME }}  # ä½¿ç”¨ä½ åœ¨GitHubä»“åº“ä¸­è®¾ç½®çš„secretï¼ˆDOCKER_USERNAMEï¼‰
          password: ${{ secrets.DOCKER_PASSWORD }}  # ä½¿ç”¨ä½ åœ¨GitHubä»“åº“ä¸­è®¾ç½®çš„secretï¼ˆDOCKER_PASSWORDï¼‰

      - name: Install and Build ğŸ”§  # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®
        run: |
          if [ ${{ steps.check-lock-file.outputs.exists }} == 'true' ]; then  # å¦‚æœå­˜åœ¨ package-lock.json æ–‡ä»¶ï¼Œåˆ™è¿è¡Œ npm ci
            npm ci
          else
            npm install
          fi
          npm run build

      - name: Build Docker Image  # ç¬¬äº”æ­¥ï¼šæ„å»º Docker é•œåƒ
        run: docker build -t devinglaw/demo:latest .  # ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒï¼Œå¹¶è®¾ç½®é•œåƒæ ‡ç­¾ä¸º devinglaw/demo:latest

      - name: Push Docker Image  # ç¬¬å…­æ­¥ï¼šå°† Docker é•œåƒæ¨é€åˆ° DockerHub
        run: docker push devinglaw/demo:latest  # å°†æ„å»ºå¥½çš„é•œåƒ push åˆ° DockerHub

      - name: Deploy ğŸš€  # ç¬¬ä¸ƒæ­¥ï¼šéƒ¨ç½²
        uses: JamesIves/github-pages-deploy-action@v4  # ä½¿ç”¨actionåº“ä¸­çš„github-pages-deploy-actionæ–¹æ³•
        with:
          folder: build  # éƒ¨ç½²çš„æ–‡ä»¶å¤¹
          token: ${{ secrets.DEPLOY_TOKEN }}  # ä½¿ç”¨ä½ åœ¨GitHubä»“åº“ä¸­è®¾ç½®çš„secretï¼ˆDEPLOY_TOKENï¼‰
          branch: main  # éƒ¨ç½²çš„åˆ†æ”¯
